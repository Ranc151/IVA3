<style>
    #mapboxContainer {
        margin: 0;
        padding-top: 50px;
        width: 100%;
        height: 100vh;
        display: grid;
    }

    #mapbox {
        width: 100%;
        height: 100%;
        z-index: 1;
    }

    #layerSidebar,
    #functionSidebar,
    #typeSidebar {
        position: fixed;
        top: 100px;
        height: auto;
        background: none;
        padding: 0;
        margin: 0;
        border: 1px solid #ccc;
        font-size: 1;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
        border: none;
    }

    #layerSidebar {
        right: 3vw;
        z-index: 2;
    }

    #functionSidebar {
        left: 3vw;
        display: flex;
        flex-direction: column;
        z-index: 3;
    }

    #controlSidebar {
        left: 3vw;
        padding-left: 100px;
        z-index: 2;
        display: flex;
        flex-direction: column;
        top: 180px;
        background-color: #fff;
        font-family: 'Poppins', sans-serif;
        text-align: center;
        align-items: center;
        width: 100px;
        height: auto;

    }

    #typeSidebar {
        left: 3vw;
        padding-left: 70px;
        z-index: 4;
        flex-direction: row;
        top: 180px;
        display: flex;
    }

    #mapboxContainer i {
        font-size: x-large;
        color: #3e50a8;
    }

    #mapboxContainer .function {
        display: flex;
        flex-direction: row;
        align-items: center;
        height: 60px;
        width: 60px;
        margin: 5px;
        overflow: hidden;
        background: #fff;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0px 10px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease-out;
        font-size: 13px;
        text-align: center;
    }

    #functionSidebar .function:hover {
        width: 220px;
    }

    #mapboxContainer .function .icon {
        display: inline-block;
        align-items: center;
        height: 60px;
        width: 60px;
        text-align: center;
        border-radius: 50px;
        box-sizing: border-box;
        line-height: 60px;
        transition: all 0.3s ease-out;
        margin: 0 20px;
    }

    #mapboxContainer .function .icon i {
        font-size: 25px;
        line-height: 60px;
        transition: all 0.3s ease-out;
    }

    #typeSidebar .function {
        width: 40px;
        height: 40px;
        font-size: 16px;
        border-radius: 30px;
        margin: 5px;
    }

    #typeSidebar .function .icon {
        margin: 0 5px;
    }

    #mapboxContainer .function:hover .icon i {
        color: #62ff82;
    }
</style>

<div id="mapboxContainer">
    <div id="mapbox" style="width: 100%; height: 100vh;"></div>
    <div id="layerSidebar">
        <form id="layerForm">
            <div><input type="checkbox" name="coffee" value="coffee"><i class="fa-solid fa-mug-hot"></i><br></div>
            <div><input type="checkbox" name="bar" value="bar"><i class="fa-solid fa-martini-glass"></i><br></div>
            <div><input type="checkbox" name="bus" value="bus"><i class="fa-solid fa-bus"></i><br></div>
            <div><input type="checkbox" name="train" value="train"><i class="fa-solid fa-train"></i><br></div>
            <div><input type="checkbox" name="tram" value="tram"><i class="fa-solid fa-train-tram"></i><br></div>
            <div><input type="checkbox" name="park" value="park"><i class="fa-solid fa-square-parking"></i><br>
            </div>
        </form>
    </div>
    <div id="functionSidebar">
        <div class="function" onclick="FunctionChange(1)">
            <div id="Point" class="icon"><i class="fa-solid fa-location-dot"></i></div>
            <div>Free Browse</div>
        </div>
        <div class="function" onclick="FunctionChange(2)">
            <div id="Route" class="icon"><i class="fa-solid fa-route"></i></div>
            <div>Generate route</div>
        </div>
        <div class="function" onclick="FunctionChange(3)">
            <div id="Isochrone" class="icon"><i class="fa-solid fa-draw-polygon"></i></div>
            <div>Show Isochrone</div>
        </div>
    </div>
    <div id="controlSidebar">
        <div id="funcntionName"></div>
        <div id="typeLine"></div>
        <div id="typeSidebar">
            <div class="function" onclick="TypeChange(1)">
                <div id="driving" class="icon"><i class="fa-solid fa-car"></i></div>
                <!-- <div>Drive</div> -->
            </div>
            <div class="function" onclick="TypeChange(2)">
                <div id="cycling" class="icon"><i class="fa-solid fa-bicycle"></i>></div>
                <!-- <div>Bicycle</div> -->
            </div>
            <div class="function" onclick="TypeChange(3)">
                <div id="walking" class="icon"><i class="fa-solid fa-person-walking"></i></div>
                <!-- <div>Walking</div> -->
            </div>
        </div>
        <div id="minsLine"></div>
        <div id="minsSidebar">

        </div>
    </div>

</div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicmFuY2hlbiIsImEiOiJjbG5xemdmMm4weG1uMmpwZG0zMmFseWkyIn0.59mv2UvALzSr3S1I-YEX_A';
    var map = new mapboxgl.Map({
        container: 'mapbox',
        style: 'mapbox://styles/ranchen/clnpxlat800up01pvemzqe4z3',
        center: [144.9631, -37.8136],
        zoom: 13
    });
    var bounds = [
        [144.5, -38.5],
        [145.5, -37.5]
    ];

    map.setMaxBounds(bounds);

    let currentFunction = "Point";
    let currentType = "driving";
    var typeBar = document.querySelector("#typeSidebar");
    var popup;

    function FunctionChange(num) {
        const ToRemove = ['startPoint', 'endPoint', 'route', 'iso'];
        ToRemove.forEach(layerName => {
            if (map.getLayer(layerName)) {
                map.removeLayer(layerName);
            }
        });
        ToRemove.forEach(sourceName => {
            if (map.getSource(sourceName)) {
                map.removeSource(sourceName);
            }
        });
        popup.remove();
        marker.remove();
        if (num === 1) {
            currentFunction = "Point";
            typeBar.style.display = "none";
        } else if (num === 2) {
            currentFunction = "Route";
            typeBar.style.display = "flex";
        } else if (num === 3) {
            currentFunction = "Isochrone";
            typeBar.style.display = "flex";
        }
    }

    function TypeChange(num) {
        if (num === 1) {
            currentType = "driving";
        } else if (num === 2) {
            currentType = "cycling";
        } else if (num === 3) {
            currentType = "walking";
        }
    }

    async function getRoute(start, end) {
        const query = await fetch(
            `https://api.mapbox.com/directions/v5/mapbox/${currentType}/${start[0]},${start[1]};${end[0]},${end[1]}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`,
            { method: 'GET' }
        );
        const json = await query.json();
        const data = json.routes[0];
        console.log(data);
        const route = data.geometry.coordinates;
        const geojson = {
            type: 'Feature',
            properties: {},
            geometry: {
                type: 'LineString',
                coordinates: route
            }
        };

        map.addLayer({
            id: 'route',
            type: 'line',
            source: {
                type: 'geojson',
                data: geojson
            },
            layout: {
                'line-join': 'round',
                'line-cap': 'round'
            },
            paint: {
                'line-color': '#3887be',
                'line-width': 5,
                'line-opacity': 0.75
            }
        });
    }


    // 等时线的参数
    const urlBase = 'https://api.mapbox.com/isochrone/v1/mapbox/';
    let minutes = 10;
    const marker = new mapboxgl.Marker({
        'color': '#314ccd'
    });

    async function getIso(coordinates) {
        const query = await fetch(
            `https://api.mapbox.com/isochrone/v1/mapbox/${currentType}/${coordinates[0]},${coordinates[1]}?contours_minutes=${minutes}&polygons=true&access_token=${mapboxgl.accessToken}`,
            { method: 'GET' }
        );
        const data = await query.json();
        // Set the 'iso' source's data to what's returned by the API query
        map.getSource('iso').setData(data);
    }

    map.on('click', (event) => {
        if (map.getLayer('iso')) {
            map.removeLayer('iso');
        }
        marker.remove();
        if (currentFunction === "Point") {
            const features = map.queryRenderedFeatures(event.point, {
                layers: ['poi-label', 'parking']
            });
            if (!features.length) {
                return;
            }
            const feature = features[0];
            const coordinates = feature.geometry.coordinates;
            popup = new mapboxgl.Popup({ offset: [0, -10] })
                .setLngLat(coordinates)
                .setHTML(
                    `<h3>${feature.properties.title}</h3><p>${feature.properties.description}</p>`
                )
                .addTo(map);
            marker.setLngLat(coordinates).addTo(map);
        } else if (currentFunction === "Route") {
            const coordinates = Object.keys(event.lngLat).map((key) => event.lngLat[key]);
            if (map.getLayer('startPoint') && (!map.getLayer('endPoint'))) {
                map.addLayer({
                    id: 'endPoint',
                    type: 'circle',
                    source: {
                        type: 'geojson',
                        data: {
                            type: 'FeatureCollection',
                            features: [
                                {
                                    type: 'Feature',
                                    properties: {},
                                    geometry: {
                                        type: 'Point',
                                        coordinates: coordinates
                                    }
                                }
                            ]
                        }
                    },
                    paint: {
                        'circle-radius': 10,
                        'circle-color': '#f30'
                    }
                });
                const startPointcoord = (map.querySourceFeatures('startPoint'))[0].geometry.coordinates;
                console.log(startPointcoord);
                console.log(startPointcoord);
                getRoute(startPointcoord, coordinates);
            } else if (!map.getLayer('startPoint')) {
                map.addLayer({
                    id: 'startPoint',
                    type: 'circle',
                    source: {
                        type: 'geojson',
                        data: {
                            type: 'FeatureCollection',
                            features: [
                                {
                                    type: 'Feature',
                                    properties: {},
                                    geometry: {
                                        type: 'Point',
                                        coordinates: coordinates
                                    }
                                }
                            ]
                        }
                    },
                    paint: {
                        'circle-radius': 10,
                        'circle-color': '#3887be'
                    }
                });
            } else if (map.getLayer('startPoint') && map.getLayer('endPoint')) {
                map.removeLayer('startPoint');
                map.removeLayer('endPoint');
                map.removeLayer('route');
                if (map.getSource('startPoint')) {
                    map.removeSource('startPoint');
                }
                if (map.getSource('endPoint')) {
                    map.removeSource('endPoint');
                }
                if (map.getSource('route')) {
                    map.removeSource('route');
                }
                map.addLayer({
                    id: 'startPoint',
                    type: 'circle',
                    source: {
                        type: 'geojson',
                        data: {
                            type: 'FeatureCollection',
                            features: [
                                {
                                    type: 'Feature',
                                    properties: {},
                                    geometry: {
                                        type: 'Point',
                                        coordinates: coordinates
                                    }
                                }
                            ]
                        }
                    },
                    paint: {
                        'circle-radius': 10,
                        'circle-color': '#3887be'
                    }
                });
            }

        } else if (currentFunction === "Isochrone") {
            const coordinates = Object.keys(event.lngLat).map((key) => event.lngLat[key]);
            if (map.getSource('iso')) {
                map.removeSource('iso');
            }

            map.addSource('iso', {
                type: 'geojson',
                data: {
                    'type': 'FeatureCollection',
                    'features': []
                }
            });

            map.addLayer(
                {
                    'id': 'iso',
                    'type': 'fill',
                    'source': 'iso',
                    'layout': {},
                    'paint': {
                        'fill-color': '#5a3fc0',
                        'fill-opacity': 0.3
                    }
                },
                'poi-label'
            );

            marker.setLngLat(coordinates).addTo(map);
            getIso(coordinates);
        }
    });
</script>